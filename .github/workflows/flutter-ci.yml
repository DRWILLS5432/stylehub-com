name: Flutter CI

on: [push, pull_request]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: stable
          architecture: x64

      - name: Install dependencies
        run: |
          flutter pub add intl:^0.20.2
          flutter pub get

      - name: Create analysis options
        run: |
          echo "analyzer:" > analysis_options.yaml
          echo "  errors:" >> analysis_options.yaml
          echo "    argument_type_not_assignable: ignore" >> analysis_options.yaml
          echo "    missing_assignable_selector: ignore" >> analysis_options.yaml
          echo "    undefined_operator: ignore" >> analysis_options.yaml
          echo "    equality_cannot_be_equality_operand: ignore" >> analysis_options.yaml
          echo "    undefined_identifier: ignore" >> analysis_options.yaml

      - name: Run Flutter analyze and generate JSON output
        run: flutter analyze --no-fatal-infos --no-fatal-warnings --write=analysis.json

      - name: Generate HTML report
        run: |
          cat << 'EOF' > generate_report.dart
          import 'dart:convert';
          import 'dart:io';

          void main() {
            final jsonString = File('analysis.json').readAsStringSync();
            final issues = jsonDecode(jsonString)['issues'] as List;
            final html = StringBuffer('''
            <!DOCTYPE html>
            <html>
            <head>
              <title>StyleHub Analysis Report</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .error { color: red; }
                .warning { color: orange; }
                .info { color: blue; }
              </style>
            </head>
            <body>
              <h1>StyleHub Code Analysis Report</h1>
              <table>
                <tr>
                  <th>Severity</th>
                  <th>File</th>
                  <th>Line</th>
                  <th>Message</th>
                  <th>Code</th>
                </tr>
            ''');

            for (var issue in issues) {
              final severity = issue['severity'].toString().toLowerCase();
              final file = issue['location']['file'];
              final line = issue['location']['startLine'];
              final message = issue['message'];
              final code = issue['code'];
              html.writeln('''
                <tr class="$severity">
                  <td>$severity</td>
                  <td>$file</td>
                  <td>$line</td>
                  <td>$message</td>
                  <td>$code</td>
                </tr>
              ''');
            }

            html.writeln('</table></body></html>');
            File('analysis-report/index.html').writeAsStringSync(html.toString());
          }
          EOF
          dart run generate_report.dart

      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: analysis-report/
